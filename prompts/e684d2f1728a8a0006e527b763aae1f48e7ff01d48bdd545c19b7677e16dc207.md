---
name: E2E Test
description: End-to-end testing guide for clumsies CLI v2
---

# 指令3: E2E 测试

## 描述

对 clumsies CLI v2 进行端到端测试。新架构将 .prompts/ 作为独立的 git 仓库管理。

## 前置准备

### 1. 创建测试用远程仓库

```bash
# 清理旧的测试环境
rm -rf /tmp/clumsies-test-prompts
rm -rf /tmp/clumsies-test-registry
rm -rf ~/.clumsies/

# 创建 bare 仓库作为"远程"
git init --bare /tmp/clumsies-test-prompts
git init --bare /tmp/clumsies-test-registry
```

### 2. 构建 clumsies

```bash
cd /path/to/clumsies
zig build
```

## 执行步骤

### 阶段1: 基础命令

```bash
# 版本和帮助
./zig-out/bin/clumsies --version
./zig-out/bin/clumsies --help

# 未初始化时的错误处理
./zig-out/bin/clumsies status  # 应提示未初始化
./zig-out/bin/clumsies push    # 应提示未初始化
```

### 阶段2: 初始化和主命令

```bash
# 进入测试目录
cd /tmp/test-project
rm -rf .prompts/

# 初始化
./zig-out/bin/clumsies init /tmp/clumsies-test-prompts

# 验证
ls -la .prompts/.git/
./zig-out/bin/clumsies status

# 创建一些测试文件
mkdir -p .prompts/command
cat > .prompts/command/00_TEST.md << 'EOF'
# Test Command

This is a test command.
EOF

# 推送
./zig-out/bin/clumsies push -m "Add test command"

# 验证远程
cd /tmp/clumsies-test-prompts
git log --oneline

# 查看历史
cd /tmp/test-project
./zig-out/bin/clumsies log
```

**预期结果**:
- init: 创建 .prompts/ 目录，初始化 git，添加 remote
- status: 显示 git status
- push: 提交并推送到远程
- log: 显示 commit 历史

### 阶段3: Clone 命令

```bash
cd /tmp
rm -rf test-project-2
mkdir test-project-2
cd test-project-2

# Clone
./zig-out/bin/clumsies clone /tmp/clumsies-test-prompts

# 验证
ls -la .prompts/
cat .prompts/command/00_TEST.md

# 尝试再次 clone（应失败）
./zig-out/bin/clumsies clone /tmp/clumsies-test-prompts
# 应报错：.prompts/ already exists
```

**预期结果**:
- clone: 克隆远程仓库到 .prompts/
- 目录已存在时报错

### 阶段4: Pull 命令

```bash
# 在 project-1 中添加新文件
cd /tmp/test-project
cat > .prompts/command/01_NEW.md << 'EOF'
# New Command
EOF
./zig-out/bin/clumsies push -m "Add new command"

# 在 project-2 中拉取
cd /tmp/test-project-2
./zig-out/bin/clumsies pull

# 验证
ls .prompts/command/
# 应显示 00_TEST.md 和 01_NEW.md
```

### 阶段5: Config 命令

```bash
# 设置配置
./zig-out/bin/clumsies config set lang zh
./zig-out/bin/clumsies config set registry /tmp/clumsies-test-registry

# 查看配置
./zig-out/bin/clumsies config list
# 应显示:
# lang     = zh
# registry = /tmp/clumsies-test-registry

./zig-out/bin/clumsies config get registry
```

### 阶段6: Registry 命令 (-P/-B)

```bash
# 初始化 registry
cd /tmp
git clone /tmp/clumsies-test-registry registry-local
cd registry-local
mkdir -p prompts templates

# 创建 index.json
cat > prompts/index.json << 'EOF'
{
  "prompts": [
    {
      "hash": "abc12345def67890",
      "name": "command/review-commit",
      "description": "Review git changes and generate commit message",
      "created_at": "1736668800"
    }
  ]
}
EOF

# 创建 prompt 文件
cat > prompts/abc12345def67890.md << 'EOF'
---
name: Review Commit
description: Review git changes and generate commit message
---

# Review Commit

Check git status and diff, then generate commit message.
EOF

# 推送到远程
git add -A && git commit -m "Add sample prompt" && git push

# 测试 list
cd /tmp/test-project
./zig-out/bin/clumsies list -P
# 应显示:
# HASH      CREATED     NAME                      DESCRIPTION
# abc12345  2024-01-12  command/review-commit     Review git changes...

# 测试 show
./zig-out/bin/clumsies show -P abc12345

# 测试 add
./zig-out/bin/clumsies add -P abc12345
ls .prompts/command/
# 应显示带序号的新文件 02_REVIEW_COMMIT.md
```

**预期结果**:
- list -P: 从 registry 列出 prompts
- show -P: 显示 prompt 内容
- add -P: 复制 prompt 到本地 .prompts/，自动添加序号

### 阶段7: Init 场景测试

```bash
cd /tmp
rm -rf init-test
mkdir init-test
cd init-test

# 场景1: 无 .prompts/ 目录
./zig-out/bin/clumsies init /tmp/clumsies-test-prompts
# 应成功

# 场景2: 已有 remote
./zig-out/bin/clumsies init /tmp/clumsies-test-prompts
# 应报错：已初始化

# 场景3: --force 覆盖
./zig-out/bin/clumsies init /tmp/other-remote.git --force
# 应成功覆盖 remote
```

## 注意事项

- 每次测试前清理环境：`rm -rf ~/.clumsies/ .prompts/`
- 测试时使用本地 bare git 仓库作为远程
- 验证 .prompts/.git/ 目录存在是关键

## 常见问题

### Q: Push 失败
A: 检查 .prompts/.git/config 中的 remote 配置

### Q: List -P 报错 Registry not configured
A: 运行 `clumsies config set registry <url>` 先配置 registry

### Q: Clone 后 status 报错
A: 确认 clone 成功创建了 .prompts/.git/ 目录
